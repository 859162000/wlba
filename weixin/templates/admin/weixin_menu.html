{% extends "admin/base_site.html" %}
{% load i18n admin_static admin_list admin_urls suit_list suit_tags %}
{% load url from future %}
{% block extrastyle %}
     <link rel="stylesheet" type="text/css" href="{% static 'admin/css/weixin_menu.css' %}" media="all">
{% endblock %}

{% block content %}
<div id="content-main" ng-app="app">
    <div>
        <p>当前公众账号：{{ account.name }}</p>
    </div>
    <div ng-controller="MenuCtl">

        <div id="weixin_menu">
            <div class="weixin_menu_main"></div>
            <div class="weixin_menu_body">
                <div ng-repeat="menu in data.menu.button" class="weixin_menu_item" ng-click="">
                    <div ng-click="choice_menu(1, $index)">
                        <span ng-bind="menu.name"></span>
                        <i class="weixin_sub_button_icon" ng-hide="menu.type && menu.type != 'sub_button'"></i>
                    </div>
                    <div class="weixin_menu_sub_button_box" ng-hide="! menu.sub_button" ng-init="parent_index = $index;">
                        <button type="button" ng-click="add_menu(2, $index);" ng-hide="(menu.type && menu.type != 'sub_button') || menu.sub_button.length >= 5">添加二级菜单</button>
                        <div ng-repeat="sub_button in menu.sub_button" class="weixin_menu_sub_button" ng-click="choice_menu(2, $index, parent_index)"><span ng-bind="sub_button.name"></span></div>
                    </div>
                </div>
            </div>
            <div class="weixin_menu_handler">
                <a href="javascript:void(0);" ng-click="add_menu(1);" ng-hide="data.menu.button.length >= 3">添加一级菜单</a>
                <a href="javascript:void(0);" ng-click="create_menu();">生成菜单</a>
                <a href="javascript:void(0);" ng-click="delete_menu();">删除菜单</a>
            </div>
        </div>

        <div id="weixin_menu_set" ng-hide="data.new_menu == null;">
            <form name="new_menu_form" ng-submit="add_menu_confirm()">
                <div>
                    <label for="">类型</label>
                    <select name="" id=""
                            ng-model="data.new_menu.type"
                            ng-options="item.value as item.text for item in data.menu_classify" ng-change="">
                    </select>
                </div>
                <div>
                    <label for="">名称</label>
                    <input type="text" name="name" id="" ng-model="data.new_menu.name" ng-minlength="1" ng-maxlength="data.name_max_length" ng-required="true"/>
                </div>
                <div ng-hide="data.new_menu.type == 'view' || data.new_menu.type == 'sub_button'">
                    <label for="">Key</label>
                    <input type="text" name="key" id="" ng-model="data.new_menu.key" ng-required="data.new_menu.type != 'view' && data.new_menu.type != 'sub_button'"/>
                </div>
                <div ng-hide="data.new_menu.type != 'view'">
                    <label for="">链接</label>
                    <input type="url" name="url" id="" ng-model="data.new_menu.url" ng-required="data.new_menu.type == 'view'"/>
                </div>
                <div>
                    <button type="submit" ng-disabled="new_menu_form.$invalid">确定</button>
                </div>
                <div ng-hide="data.current_menu_index == null">
                    <button type="button" ng-click="remove_menu()">删除</button>
                    <button type="button" ng-click="move_menu('left')" ng-bind="data.move_menu_left_btn" ng-hide="is_move_menu_left_hidden()"></button>
                    <button type="button" ng-click="move_menu('right')" ng-bind="data.move_menu_right_btn" ng-hide="is_move_menu_right_hidden()"></button>
                </div>
            </form>
        </div>
        <div style="margin-left: 400px;">
            <pre ng-bind="data.new_menu|json">

            </pre>
            <pre ng-bind="data.menu|json">

            </pre>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
    <script type="text/javascript" src="{% static 'admin/js/libs/angularjs/angular.min.js' %}"></script>
    <script>
        var app = angular.module('app', []);

        app.config(['$interpolateProvider', function ($interpolateProvider) {
            $interpolateProvider.startSymbol('<{');
            $interpolateProvider.endSymbol('}>');
        }]);

        app.controller('MenuCtl', function($scope, $http) {
            $scope.data = {};
            $scope.data.menu_classify_all = [
                {'value': 'sub_button', 'text': '子菜单'},
                {'value': 'click', 'text': '点击推事件'},
                {'value': 'view', 'text': '跳转URL'},
                {'value': 'scancode_push', 'text': '扫码推事件'},
                {'value': 'scancode_waitmsg', 'text': '扫码推事件且弹出“消息接收中”提示框'},
                {'value': 'pic_sysphoto', 'text': '弹出系统拍照发图'},
                {'value': 'pic_photo_or_album', 'text': '弹出拍照或者相册发图'},
                {'value': 'pic_weixin', 'text': '弹出微信相册发图器'},
                {'value': 'location_select', 'text': '弹出地理位置选择器'}
            ];
            $scope.data.menu = JSON.parse('{{ menu | safe }}');
            $scope.data.menu_classify = null;
            $scope.data.current_menu_level = null;
            $scope.data.current_menu_index = null;
            $scope.data.current_menu_parent_index = null;
            $scope.data.new_menu = null;
            $scope.data.new_menu_action = null;

            $scope.$watch('data.current_menu_level', function(level) {
                if (level == 1) {
                    $scope.data.move_menu_left_btn = '左移';
                    $scope.data.move_menu_right_btn = '右移';
                }
                else if (level == 2) {
                    $scope.data.move_menu_left_btn = '上移';
                    $scope.data.move_menu_right_btn = '下移';
                }
            });

            function set_name_max_length(level) {
                if (level == 1) {
                    $scope.data.name_max_length = 4;
                }
                else if (level == 2) {
                    $scope.data.name_max_length = 7;
                }
            }

            function init_current_menu(level, index, parent_index) {
                $scope.data.current_menu_level = level;
                $scope.data.current_menu_index = index;
                $scope.data.current_menu_parent_index = parent_index;
                set_name_max_length(level);
            }

            function reset_current_menu() {
                $scope.data.current_menu_level = null;
                $scope.data.current_menu_index = null;
                $scope.data.current_menu_parent_index = null;
            }

            $scope.add_menu = function(level, index) {
                $scope.data.new_menu_action = 'create';
                $scope.data.new_menu = {
                    'type': 'click',
                    'name': '',
                    'key': ''
                };

                $scope.data.menu_classify = angular.copy($scope.data.menu_classify_all);
                if (level == 2) {
                    $scope.data.menu_classify.shift();
                }
                $scope.data.new_menu_parent = index;
                reset_current_menu();
                set_name_max_length(level);
            };

            $scope.remove_menu = function() {
                var confirm = window.confirm('确定删除吗');
                if (! confirm) {
                    return false;
                }

                if ($scope.data.current_menu_level == 1) {
                    $scope.data.menu.button.splice($scope.data.current_menu_index, 1);
                }
                else if ($scope.data.current_menu_level == 2) {
                    $scope.data.menu.button[$scope.data.current_menu_parent_index].sub_button.splice($scope.data.current_menu_index, 1);
                }

                reset_current_menu();
                $scope.data.new_menu = null;
            };

            $scope.add_menu_confirm = function() {
                var new_menu_data = angular.copy($scope.data.new_menu);
                var menu_data;

                if (new_menu_data.type == 'sub_button') {
                    menu_data = {
                        'name': new_menu_data.name,
                        'sub_button': new_menu_data.sub_button || []
                    }
                }
                else if (new_menu_data.type == 'view') {
                    menu_data = {
                        'type': new_menu_data.type,
                        'name': new_menu_data.name,
                        'url': new_menu_data.url
                    }
                }
                else {
                    menu_data = {
                        'type': new_menu_data.type,
                        'name': new_menu_data.name,
                        'key': new_menu_data.key
                    }
                }
                $scope.data.new_menu = null;
                if ($scope.data.new_menu_action == 'create') {
                    if (typeof($scope.data.new_menu_parent) != 'undefined') {
                        $scope.data.menu.button[$scope.data.new_menu_parent].sub_button.push(menu_data);
                    }
                    else {
                        $scope.data.menu.button.push(menu_data);
                    }
                }
                else if ($scope.data.new_menu_action == 'edit') {
                    if ($scope.data.current_menu_level == 1) {
                        $scope.data.menu.button.splice($scope.data.current_menu_index, 1, menu_data);
                    }
                    else if ($scope.data.current_menu_level == 2) {
                        $scope.data.menu.button[$scope.data.current_menu_parent_index].sub_button.splice($scope.data.current_menu_index, 1, menu_data);
                    }
                }
                reset_current_menu();
                return false;
            };

            $scope.choice_menu = function(level, index, parent_index) {
                var current_list;
                init_current_menu(level, index, parent_index);
                $scope.data.new_menu_action = 'edit';
                $scope.data.menu_classify = angular.copy($scope.data.menu_classify_all);

                if (level == 1) {
                    current_list = $scope.data.menu.button;
                    $scope.data.new_menu = angular.copy(current_list[index]);
                    $scope.data.new_menu.type = $scope.data.new_menu.type || 'sub_button';
                }
                else if (level == 2) {
                    current_list = $scope.data.menu.button[parent_index].sub_button;
                    $scope.data.new_menu = angular.copy(current_list[index]);
                    $scope.data.menu_classify.shift();
                }

                $scope.data.current_list_length = current_list.length;
            };

            $scope.move_menu = function(direction) {
                var menu, parent;

                if ($scope.data.current_menu_index <= 0 && direction == 'left') {
                    return false;
                }

                if ($scope.data.current_menu_level == 1) {
                    parent = $scope.data.menu.button;
                }
                else if ($scope.data.current_menu_level == 2) {
                    parent = $scope.data.menu.button[$scope.data.current_menu_parent_index].sub_button;
                }

                if ($scope.data.current_menu_index >= parent.length - 1 && direction == 'right') {
                    return false;
                }

                menu = angular.copy(parent[$scope.data.current_menu_index]);
                parent.splice($scope.data.current_menu_index, 1);

                if (direction == 'left') {
                    $scope.data.current_menu_index -= 1;
                }
                else if (direction == 'right') {
                    $scope.data.current_menu_index += 1;
                }

                parent.splice($scope.data.current_menu_index, 0, menu);
            };

            $scope.is_move_menu_left_hidden = function() {
                return $scope.data.current_menu_index <= 0;
            };

            $scope.is_move_menu_right_hidden = function() {
                return ($scope.data.current_menu_index >= $scope.data.current_list_length -1 && $scope.data.current_menu_level == 1) ||
                        ($scope.data.current_menu_index >= $scope.data.current_list_length -1 && $scope.data.current_menu_level == 2);
            };

            $scope.create_menu = function() {
                var url = '{% url 'admin_weixin_menu_create_api' %}';
                $http.post(url, $scope.data.menu).success(function(res) {
                    if (res['errcode'] == 0) {
                        alert('生成成功');
                    }
                    else {
                        alert('生成失败');
                    }
                });
            };

            $scope.delete_menu = function() {
                var url = '{% url 'admin_weixin_menu_delete_api' %}';
                $http.post(url).success(function(res) {
                     if (res['errcode'] == 0) {
                         alert('删除成功');
                     }
                     else {
                         alert('删除失败');
                     }
                });
            };

        });

    </script>
{% endblock %}