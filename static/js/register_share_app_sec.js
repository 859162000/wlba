// Generated by CoffeeScript 1.7.1
(function() {
  require.config({
    paths: {
      jquery: 'lib/jquery.min',
      jquerymobile: 'lib/jquery.mobile.custom.min'
    }
  });

  require(['jquery', 'lib/backend', 'jquerymobile'], function($, backend, mobile) {
    var Request, checkMobile, req_identifier, _countDown;
    _countDown = function() {
      var count, element, intervalId, timerFunction;
      element = $('#sendValidateCodeButton');
      count = 60;
      $(element).prop('disabled', true);
      timerFunction = function() {
        if (count >= 1) {
          count--;
          $(element).html('已经发送(' + count + ')');
          return $(element).addClass("disabled");
        } else {
          clearInterval(intervalId);
          $(element).html('重新获取');
          $(element).prop('disabled', false);
          return $(element).removeClass("disabled");
        }
      };
      timerFunction();
      return intervalId = setInterval(timerFunction, 1000);
    };
    $('#sendValidateCodeButton').click(function(event) {
      var target;
      target = $(event.target).attr('data-url');
      $.post(target).done(function() {
        return $('#sendValidateCodeButton').prop('disabled', false);
      });
      return _countDown();
    });
    Request = new Object();
    Request = backend.getRequest();
    req_identifier = Request['identifier'];
    if (req_identifier) {
      $(".re_identifier").text(req_identifier);
    }
    checkMobile = function(identifier) {
      var re;
      re = void 0;
      re = /^1\d{10}$/;
      return re.test(identifier);
    };
    $("#button-get-validate-code-modal").click(function(e) {
      var element, identifier;
      element = this;
      if ($(element).hasClass('disable')) {
        return;
      }
      $(".error-message").text("");
      identifier = $("#reg_identifier").val().trim();
      if (!identifier) {
        $(".error-message").text("请输入手机号");
      }
      if (checkMobile(identifier)) {
        return backend.userExists(identifier).done(function() {
          $(".popup-message").text("您输入的手机号已注册过网利宝！");
          $("#popupDialog").popup('open');
          return $("#popupDialog").on("popupafterclose", function() {
            window.location.href = "#stepDownloadOld";
            return true;
          });
        }).fail(function() {
          $(".popup-message").text("验证码已发送至您手机，请注意查收。");
          $("#popupDialog").popup('open');
          return $("#popupDialog").on("popupafterclose", function() {
            $(".re_identifier").text(identifier);
            window.location.href = "?identifier=" + identifier + "#stepRegister";
            return true;
          });
        });
      } else {
        return $(".error-message").text("手机号输入错误");
      }
    });
    return $("#register_submit").click(function(e) {
      var element, identifier, invite_code, validate_code;
      element = this;
      if ($(element).hasClass("disable")) {
        return;
      }
      $(".error-message").text("");
      identifier = $("#reg_identifier").val().trim();
      if (!checkMobile(identifier)) {
        $(".error-message").text("手机号输入错误");
        return;
      }
      validate_code = $("#id_validate_code").val().trim();
      if (validate_code.length !== 6) {
        $(".error-message").text("请输入6位验证码");
        return;
      }
      invite_code = $("#reg_invitecode").val().trim();
      if (invite_code.length > 0 && invite_code.length !== 6) {
        $(".error-message").text("请输入6位邀请码");
        return;
      }
      $(element).addClass('disable');
      return backend.registerWap({
        identifier: identifier,
        validate_code: validate_code,
        invite_code: invite_code
      }).done(function(data) {
        if (data.ret_code > 0) {
          $(element).removeClass('disable');
          return $(".error-message").text(data.message);
        } else {
          return window.location.href = '/';
        }
      }).fail(function() {
        return $(".error-message").text("注册失败");
      });
    });
  });

}).call(this);
