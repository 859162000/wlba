// Generated by CoffeeScript 1.7.1
(function() {
  require.config({
    paths: {
      jquery: 'lib/jquery.min'
    }
  });

  require(['jquery', 'lib/backend'], function($, backend) {
    var _countDown;
    _countDown = function() {
      var count, element, intervalId, timerFunction;
      element = $('#sendValidateCodeButton');
      intervalId;
      count = 60;
      $(element).addClass('disabled');
      $(element).prop('disabled', true);
      timerFunction = function() {
        if (count >= 1) {
          count--;
          return $(element).text('已经发送(' + count + ')');
        } else {
          clearInterval(intervalId);
          $(element).text('重新获取');
          $(element).prop('disabled', false);
          return $(element).removeClass('disabled');
        }
      };
      timerFunction();
      return intervalId = setInterval(timerFunction, 1000);
    };
    _countDown();
    $('#sendValidateCodeButton').click(function(event) {
      var element, target;
      element = this;
      if ($(element).hasClass('disabled')) {
        return;
      }
      target = $(event.target).attr('data-url');
      $.post(target).done(function() {
        return $('#sendValidateCodeButton').addClass('disabled');
      });
      return _countDown();
    });
    return $("#register_submit").click(function(e) {
      var ajax_url, element, identifier, invite_code, reg_password, validate_code;
      element = this;
      if ($(element).hasClass("disabled")) {
        return;
      }
      $(".error-message").text("");
      identifier = $("#reg_identifier").val().trim();
      reg_password = $("#reg_password").val().trim();
      validate_code = $("#reg_validate_code").val().trim();
      invite_code = $("#reg_invitecode").val().trim();
      if (validate_code.length !== 6) {
        $(".error-message").text("请输入6位验证码");
        return;
      }
      if (!reg_password && reg_password.length < 6) {
        $(".error-message").text("请输入密码");
        return;
      }
      $(element).addClass('disabled');
      $(element).prop('disabled', true);
      ajax_url = $("#register-form").attr('action');
      console.log(ajax_url);
      return backend.registerShare({
        identifier: identifier,
        password: reg_password,
        validate_code: validate_code,
        invite_code: invite_code
      }).done(function(data, textStatus) {
        if (data.ret_code > 0) {
          $(element).removeClass('disable');
          return $(".error-message").text(data.message);
        } else {
          return window.location.href = "/activity/wap/share?phone=" + identifier + "&reg=y";
        }
      }).fail(function(xhr) {
        alert("注册失败。\n您可以去网利宝网站（www.wanglibao.com）试试。");
        return window.location.href = "/";
      });
    });
  });

}).call(this);
